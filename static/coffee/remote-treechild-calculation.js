// Generated by CoffeeScript 1.4.0

/*
For the remote soft calculation procedure
variables:
1. INTERVAL_TIME = ms for the next call
2. MAX_CALLS
3. '#calc_spinner' for the div animation
4. '#calc_result' for where to place the calculation
5. call_url
*/


(function() {
  var $, result_families_func;

  $ = jQuery;

  result_families_func = function(val) {
    var div, family, how_many, i, output, s, _i, _len, _results;
    $("#calc_families_spinner").hide();
    if (!val) {
      val = "Cannot generate tree-child family";
      $("#families_field").show();
      $("#families_field").html(val);
      return $("#tree-child-message-no").show();
    } else {
      how_many = val.length;
      $("#tree-child-number").html(how_many);
      $("#tree-child-message-yes").show();
      _results = [];
      for (i = _i = 0, _len = val.length; _i < _len; i = ++_i) {
        family = val[i];
        s = "#family-" + i;
        output = Viz(family, "svg");
        div = "<div class=\"tree-child-graph\" id=\"" + s + "\">" + output + "</div>";
        _results.push($("#rendered-families").append(div));
      }
      return _results;
    }
  };

  $(document).ready(function() {
    var INTERVAL_TIME, MAX_CALLS, call_counter, job_families_url, network_url;
    MAX_CALLS = 12 * 15;
    INTERVAL_TIME = 5000;
    job_families_url = "/job/families/";
    network_url = "" + job_families_url + queue_id + "/" + families_job_id;
    call_counter = 0;
    return $.getJSON(network_url, function(result) {
      var interval;
      if (result['status'] === 'done') {
        return result_families_func(result['value']);
      } else {
        return interval = setInterval(function() {
          return $.getJSON(network_url, function(result) {
            if (result['status'] === 'done') {
              result_families_func(result['value']);
              return clearInterval(interval);
            } else {
              call_counter += 1;
              if (call_counter > MAX_CALLS) {
                clearInterval(interval);
                $("#calc_families_spinner").hide();
                return $("#families_field").html("Something went wrong");
              }
            }
          });
        }, INTERVAL_TIME);
      }
    });
  });

}).call(this);
